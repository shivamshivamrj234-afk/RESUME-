<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total Sale Calculator (Pro)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Configuration for gradient, glow, and animation -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'neon-teal': '#2dd4bf', // Neon Teal
                        'neon-indigo': '#818cf8', // Neon Indigo
                    },
                    boxShadow: {
                        // Soft glow combining teal and indigo
                        'glow-lg': '0 0 15px rgba(45, 212, 191, 0.5), 0 0 25px rgba(129, 140, 248, 0.4)',
                    },
                    keyframes: {
                        pulseNeon: {
                            '0%, 100%': { boxShadow: '0 0 10px rgba(45, 212, 191, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(129, 140, 248, 0.8)' },
                        }
                    },
                    animation: {
                        pulseNeon: 'pulseNeon 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Blue to Purple Gradient Background */
            background-image: linear-gradient(to bottom right, #0f172a, #4c1d95);
        }
        .glassmorphism {
            background-color: rgba(30, 41, 59, 0.5); /* Dark Slate transparency */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(75, 85, 99, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .sidebar-panel {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen text-gray-100 dark transition-colors duration-500 overflow-x-hidden">

<div id="app">
    <!-- Content will be generated here by JavaScript -->
</div>

<script>
    // --- GLOBAL STATE & UTILITIES ---
    let state = {
        rawInput: `[01/11, 23:41] User: 10to12(5) 58,49(10)
[01/11, 23:45] User: 1,2,3(8) ab
[02/11, 00:10] User: 10-15(20)
`,
        date: new Date().toISOString().slice(0, 10),
        grandTotal: 0,
        lineResults: [],
        skippedLines: [],
        history: [],
        isSidebarOpen: true
    };
    
    // Rupee formatting helper
    const formatRupee = (amount) => {
        return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(amount);
    };

    // Helper for Toast Notifications
    const showToast = (message) => {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        
        const id = `toast-${Date.now()}`;
        const toast = document.createElement('div');
        toast.id = id;
        toast.className = "p-3 bg-neon-teal text-gray-900 font-semibold rounded-lg shadow-xl mb-3 transition-all duration-300 transform translate-x-full opacity-0";
        toast.textContent = message;
        toastContainer.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
            toast.classList.add('translate-x-0', 'opacity-100');
        }, 10);

        // Animate out and remove
        setTimeout(() => {
            toast.classList.remove('translate-x-0', 'opacity-100');
            toast.classList.add('translate-x-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 4000);
    };

    // Replacement for alert()
    const showMessage = (message) => {
        showToast(`‚ö†Ô∏è ${message}`);
    };

    // --- HISTORY MANAGEMENT ---

    const loadHistory = () => {
        try {
            const historyJson = localStorage.getItem('sale_calculator_history_pro');
            if (historyJson) {
                state.history = JSON.parse(historyJson);
                // Sort history newest first
                state.history.sort((a, b) => new Date(b.date) - new Date(a.date));
            }
        } catch (e) {
            console.error("Could not load history:", e);
        }
    };

    const saveHistory = () => {
        if (state.grandTotal === 0 && state.lineResults.length === 0) {
            showMessage("Nothing to save. Calculate a total first!");
            return;
        }

        const newEntry = {
            id: crypto.randomUUID(),
            date: state.date,
            timestamp: new Date().toISOString(),
            grandTotal: state.grandTotal,
            lineResults: state.lineResults,
            inputSnapshot: state.rawInput.slice(0, 500) + (state.rawInput.length > 500 ? '...' : '')
        };
        
        state.history.unshift(newEntry); // Add to beginning
        
        try {
            localStorage.setItem('sale_calculator_history_pro', JSON.stringify(state.history));
            showToast("History saved successfully ‚úÖ");
            render();
        } catch (e) {
            console.error("Could not save history:", e);
            showMessage("Error saving history to local storage.");
        }
    };

    const clearHistory = () => {
        // Use a custom confirmation modal logic (not implemented here, using toast)
        if (confirm("Are you sure you want to clear all history? This cannot be undone.")) {
             try {
                localStorage.removeItem('sale_calculator_history_pro');
                state.history = [];
                showToast("History cleared üßπ");
                render();
            } catch (e) {
                console.error("Error clearing history:", e);
                showMessage("Could not clear history.");
            }
        }
    };


    // --- CALCULATION LOGIC ---

    /**
     * Rule 4: Expands ranges like 10to19 or 10-19 into 10,11,12,...,19
     */
    const expandRanges = (text) => {
        // Regex to find patterns like NtoM or N-M where N and M are numbers
        // Global search needs to be run multiple times or use a replacement function
        return text.replace(/(\d+)(?:to|-)(\d+)/gi, (match, startStr, endStr) => {
            const start = parseInt(startStr, 10);
            const end = parseInt(endStr, 10);
            
            if (start < end) {
                let sequence = [];
                for (let i = start; i <= end; i++) {
                    sequence.push(i);
                }
                return sequence.join(',');
            }
            return match; // Return original text if range is invalid
        });
    };

    /**
     * Cleans metadata, handles 'ab' modifier, expands ranges, and processes calculation.
     */
    const calculateLineTotal = (rawLine) => {
        // 1. Clean Metadata (timestamps, names, emojis, forwarded text)
        let cleaned = rawLine
            .replace(/\[.*?\]\s*[^:]+:\s*|\+91\d{10}\s*|\(\d+:\d+\)\s*|forwarded|message from|\uD83C[\uDC00-\uDFFF]|\u2700-\u27BF|[\uE000-\uF8FF]/gi, '')
            .replace(/[^\w\s,\(\)\-]/g, ' ') // Replace remaining non-safe characters with space
            .replace(/\s+/g, ' ')
            .trim();

        if (cleaned.length === 0) return null;

        // 2. Rule 5: Check for 'ab' rule and set modifier
        const containsAb = /ab/i.test(cleaned);
        const lineModifier = containsAb ? 2 : 1;
        
        // Remove 'ab' for calculation to prevent it interfering with number extraction
        let calcLine = cleaned.replace(/ab/gi, '').trim();

        // 3. Rule 4: Range Expansion
        calcLine = expandRanges(calcLine);

        // 4. Find all bracketed groups (N)
        const bracketRegex = /\((\d+)\)/g;
        let matches = [...calcLine.matchAll(bracketRegex)];

        if (matches.length === 0) return null;

        let lineTotal = 0;
        let calculationDetails = [];
        
        const brackets = matches.map(match => ({
            value: parseInt(match[1], 10),
            startIndex: match.index,
            endIndex: match.index + match[0].length,
            matchText: match[0]
        }));

        // 5. Rule 3: Process from RIGHT TO LEFT
        for (let i = brackets.length - 1; i >= 0; i--) {
            const currentBracket = brackets[i];
            
            // Define the local counting area boundary
            const startOfArea = i > 0 ? brackets[i - 1].endIndex : 0;
            const endOfArea = currentBracket.startIndex;
            
            let countArea = calcLine.substring(startOfArea, endOfArea);

            // 6. Count numbers (Rule 1)
            // Replace non-numeric/non-comma characters with spaces to cleanly split numbers
            countArea = countArea.replace(/[^\d,]/g, ' ').replace(/\s+/g, ' ').trim();

            // Tokenize by non-digit separators and filter out empty strings
            const numericTokens = countArea.split(/[^\d]+/).filter(token => token.length > 0);
            
            let count = numericTokens.length;
            
            // 7. Calculate Subtotal (Rule 2)
            const baseValue = currentBracket.value;
            const actualValue = baseValue * lineModifier;
            const subtotal = count * actualValue;
            lineTotal += subtotal;

            calculationDetails.push({
                bracketValue: baseValue, // Base value
                count: count,
                modifier: lineModifier,
                actualValue: actualValue, // Value after 'ab' multiplier
                subtotal: subtotal,
                localExpression: (countArea.trim() || 'No numbers detected') + currentBracket.matchText
            });
        }
        
        calculationDetails.reverse(); 

        return { 
            total: lineTotal, 
            originalLine: rawLine.trim(), 
            details: calculationDetails, 
            isModified: containsAb 
        };
    };

    /**
     * Main processor to calculate the grand total across all lines.
     */
    const processAllInput = () => {
        const lines = state.rawInput.split('\n');
        let grandTotal = 0;
        let lineResults = [];
        let skippedLines = [];

        for (const line of lines) {
            const result = calculateLineTotal(line);
            
            if (result) {
                grandTotal += result.total;
                lineResults.push(result);
            } else if (line.trim().length > 0) {
                 skippedLines.push(line.trim());
            }
        }
        
        state.grandTotal = grandTotal;
        state.lineResults = lineResults;
        state.skippedLines = skippedLines;

        showToast(`Calculation complete! Total: ${formatRupee(grandTotal)}`);
        render();
    };

    // --- EVENT HANDLERS ---

    const handleCalculate = () => {
        processAllInput();
    };

    const handleClean = () => {
        state.rawInput = '';
        state.grandTotal = 0;
        state.lineResults = [];
        state.skippedLines = [];
        render();
        showToast("Input and totals cleared üßº");
    };

    const handleCopyTotal = () => {
        if (state.grandTotal === 0) {
             showMessage("Total is zero. Calculate first.");
             return;
        }
        const totalText = `${formatRupee(state.grandTotal)}`;
        // navigator.clipboard is generally preferred, but sometimes restricted in iFrames.
        // Using a reliable fallback method.
        try {
            const tempInput = document.createElement('textarea');
            tempInput.value = totalText;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showToast(`Copied: ${totalText} üìã`);
        } catch (err) {
            console.error('Could not copy text: ', err);
            showMessage("Error copying total. Please copy manually.");
        }
    };
    
    // --- RENDERING FUNCTIONS ---

    const renderSidebar = () => {
        const isCollapsed = !state.isSidebarOpen;
        const mainContent = document.getElementById('main-content');
        
        // Toggle the class on the main content area for the responsive shift
        if (mainContent) {
            mainContent.className = `p-4 transition-all duration-300 ${isCollapsed ? 'sm:pl-4' : 'sm:pl-[21rem]'}`;
        }
        
        const today = new Date().toLocaleDateString('en-IN', {
            day: '2-digit', month: '2-digit', year: 'numeric'
        }).replace(/\//g, '-');
        
        return `
            <!-- Sidebar -->
            <div id="sidebar" class="sidebar-panel fixed top-0 left-0 h-full ${isCollapsed ? 'w-20 translate-x-0' : 'w-80 translate-x-0'} bg-gray-900 z-50 transition-all duration-300 shadow-2xl overflow-hidden glassmorphism">
                
                <div class="p-4 flex items-center justify-between h-20 border-b border-neon-teal/30">
                    <h2 class="text-xl font-bold text-neon-teal ${isCollapsed ? 'hidden' : 'block'} transition-opacity duration-150">TSC Pro</h2>
                    <button onclick="state.isSidebarOpen = !state.isSidebarOpen; render();" class="text-white hover:text-neon-teal text-2xl p-2 rounded-lg bg-gray-800/50 transition-colors duration-200" aria-label="Toggle Sidebar">
                        ${isCollapsed ? '&#9776;' : '&#x2715;'}
                    </button>
                </div>

                <div class="p-2 space-y-2">
                    ${['Home', 'Calculator', 'History'].map(item => `
                        <div 
                            id="btn-${item.toLowerCase().replace(' ', '-')}" 
                            class="flex items-center p-3 ${item === 'Calculator' ? 'bg-neon-teal/20' : 'hover:bg-gray-700/50'} text-sm text-gray-300 rounded-xl cursor-pointer transition-colors duration-200"
                            ${item === 'History' ? 'onclick="document.getElementById(\'history-panel\').classList.toggle(\'hidden\');"' : ''}
                        >
                            <span class="text-xl mr-3">${item === 'Home' ? 'üè†' : item === 'Calculator' ? 'üßÆ' : 'üìÖ'}</span>
                            <span class="${isCollapsed ? 'hidden' : 'block'} transition-opacity duration-150">${item}</span>
                        </div>
                    `).join('')}
                </div>
                
                <!-- History Panel (Hidden by default) -->
                <div id="history-panel" class="p-4 mt-4 space-y-3 bg-gray-800/50 ${isCollapsed ? 'hidden' : 'block'}">
                    <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                        <h3 class="text-lg font-semibold text-neon-indigo">Session History</h3>
                        <button onclick="clearHistory();" class="text-sm text-red-400 hover:text-red-300 transition-colors">Clear All</button>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto pr-1">
                        ${state.history.length > 0 ? state.history.map(entry => `
                            <div class="p-3 bg-gray-700/50 rounded-lg text-xs hover:bg-gray-700/70 transition-colors cursor-pointer" title="${entry.inputSnapshot}">
                                <p class="font-bold text-neon-teal">${entry.date}</p>
                                <p class="text-white font-mono">${formatRupee(entry.grandTotal)}</p>
                                <p class="text-gray-400 truncate">${entry.inputSnapshot}</p>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-sm">No history saved yet.</p>'}
                    </div>
                </div>
            </div>
        `;
    };

    const renderMainApp = () => {
        const formattedDate = new Date(state.date).toLocaleDateString('en-IN', {
            day: '2-digit', month: '2-digit', year: 'numeric'
        }).replace(/\//g, '-');

        return `
            <div id="main-content" class="p-4 transition-all duration-300 ${state.isSidebarOpen ? 'sm:pl-[21rem]' : 'sm:pl-4'}">
                <div class="max-w-4xl mx-auto">
                    
                    <!-- Header -->
                    <header class="py-4 mb-8 flex justify-between items-center border-b border-neon-teal/30">
                        <h1 class="text-3xl font-extrabold tracking-tight text-white">
                            <span class="text-neon-teal">Total Sale</span> <span class="text-neon-indigo">Calculator (Pro)</span>
                        </h1>
                        <div class="text-lg font-medium text-gray-400">
                             <input
                                type="date"
                                value="${state.date}"
                                onchange="state.date = this.value; render();"
                                class="bg-gray-800 text-white p-2 rounded-lg border border-gray-700 focus:ring-neon-teal focus:border-neon-teal transition-all duration-200"
                            />
                        </div>
                    </header>

                    <!-- Input Area (Glassmorphism) -->
                    <div class="mb-8 glassmorphism p-6 rounded-2xl">
                        <h2 class="text-xl font-semibold mb-3 text-white">Paste WhatsApp Chat Data</h2>
                        <textarea
                            id="input-textarea"
                            class="w-full p-4 h-48 bg-gray-900/70 text-gray-200 rounded-xl border border-gray-700 focus:ring-neon-teal focus:border-neon-teal transition-all duration-200 resize-none shadow-inner"
                            placeholder="Paste your WhatsApp chat log here (e.g., 10to19(5) 58,49(10)ab)"
                            oninput="state.rawInput = this.value; render();"
                        >${state.rawInput}</textarea>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-4 mb-10">
                        <button
                            onclick="handleClean()"
                            class="flex-1 min-w-[120px] bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] border border-gray-500/50"
                        >
                            üßπ Clean Input
                        </button>
                        <button
                            onclick="handleCalculate()"
                            class="flex-1 min-w-[120px] bg-neon-teal hover:bg-teal-500 text-gray-900 font-bold py-3 px-4 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] border border-neon-teal/50"
                        >
                            üßÆ Calculate Total
                        </button>
                        <button
                            onclick="saveHistory()"
                            class="flex-1 min-w-[120px] bg-neon-indigo hover:bg-indigo-400 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] border border-neon-indigo/50"
                        >
                            üíæ Save History
                        </button>
                         <button
                            onclick="handleCopyTotal()"
                            class="flex-1 min-w-[120px] bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] border border-gray-500/50"
                        >
                            üìã Copy Total
                        </button>
                    </div>

                    <!-- Grand Total Display -->
                    <div class="mb-12 text-center">
                        ${renderGrandTotalBox()}
                    </div>

                    <!-- Detailed Line Breakdown -->
                    <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Detailed Line Breakdown (${state.lineResults.length} Lines Processed)</h2>
                    
                    <div class="space-y-6">
                        ${state.lineResults.map((lineResult, lineIndex) => renderLineResult(lineResult, lineIndex)).join('')}
                    </div>

                    <!-- Skipped Lines Panel -->
                    ${state.skippedLines.length > 0 ? `
                        <div class="p-4 mt-6 bg-red-900/30 border border-red-700 rounded-xl mb-6 glassmorphism">
                            <h3 class="text-lg font-semibold text-red-400 mb-2">‚ö†Ô∏è Skipped Lines (${state.skippedLines.length})</h3>
                            <p class="text-sm text-red-300 mb-2">These lines were ignored (no valid bracket pattern detected):</p>
                            <ul class="text-sm text-red-200 list-disc list-inside space-y-1 max-h-24 overflow-y-auto pr-2">
                                ${state.skippedLines.map((line, index) => `<li key="${index}" class="break-words font-mono bg-red-800/50 p-1 rounded text-xs">${line}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    };

    const renderGrandTotalBox = () => {
        const formattedDate = new Date(state.date).toLocaleDateString('en-IN', {
            day: '2-digit', month: '2-digit', year: 'numeric'
        }).replace(/\//g, '-');

        return `
            <div class="p-5 sm:p-8 bg-gray-900 rounded-2xl shadow-glow-lg border border-neon-teal/50 transition-all duration-300 ${state.grandTotal > 0 ? 'animate-pulseNeon' : ''} glassmorphism">
                <p class="text-sm sm:text-base font-medium text-gray-400 mb-1">Calculation Date: <span class="text-white font-semibold">${formattedDate}</span></p>
                <p class="text-2xl sm:text-3xl lg:text-4xl font-extrabold tracking-wider text-neon-indigo">
                    GRAND TOTAL
                </p>
                <p class="text-5xl sm:text-6xl lg:text-7xl font-extrabold tracking-wider text-neon-teal mt-2">
                    ${formatRupee(state.grandTotal)}
                </p>
            </div>
        `;
    };

    const renderLineResult = (lineResult, lineIndex) => {
        return `
            <div class="glassmorphism p-4 rounded-xl shadow-md transition-all duration-300 hover:shadow-glow-lg/50">
                <h3 class="text-sm font-mono text-gray-400 mb-3 truncate">
                    Original Input: ${lineResult.originalLine}
                    ${lineResult.isModified ? '<span class="ml-2 px-2 py-0.5 bg-red-600/50 text-xs font-bold rounded-full text-white">X2 Modifier (ab)</span>' : ''}
                </h3>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Bracket Expression</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Count</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Value (Base)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actual Value</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-neon-teal uppercase tracking-wider">Subtotal (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${lineResult.details.map((detail, detailIndex) => `
                                <tr key="${detailIndex}" class="hover:bg-gray-700/50 transition-colors duration-150">
                                    <td class="px-3 py-2 whitespace-pre-wrap text-sm font-mono text-gray-200 break-words max-w-xs">${detail.localExpression}</td>
                                    <td class="px-3 py-2 text-right text-sm text-gray-300">${detail.count}</td>
                                    <td class="px-3 py-2 text-right text-sm text-gray-300">${detail.bracketValue}</td>
                                    <td class="px-3 py-2 text-right text-sm text-neon-indigo font-bold">${detail.actualValue}</td>
                                    <td class="px-3 py-2 text-right text-base font-extrabold text-neon-teal">
                                        ${formatRupee(detail.subtotal)}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="px-3 py-2 text-right text-sm font-bold text-white bg-gray-700/50">LINE TOTAL:</td>
                                <td class="px-3 py-2 text-right text-lg font-extrabold text-neon-indigo bg-gray-700/50">
                                     ${formatRupee(lineResult.total)}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        `;
    };

    const render = () => {
        const appElement = document.getElementById('app');
        appElement.innerHTML = renderSidebar() + renderMainApp();
        
        // Ensure textarea value is re-synced if rendering triggered by non-input change
        const textarea = document.getElementById('input-textarea');
        if (textarea) {
            textarea.value = state.rawInput;
        }
    };

    // Initialize the app on load
    window.onload = () => {
        // Create toast container
        const toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'fixed bottom-4 right-4 z-[9999] flex flex-col items-end pointer-events-none';
        document.body.appendChild(toastContainer);

        loadHistory();
        render();
        // Initial calculation on load for default input
        processAllInput();
    };
</script>

</body>
</html>